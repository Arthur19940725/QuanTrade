<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票预测功能调试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin-top: 10px; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>🔧 股票预测功能调试页面</h1>
    
    <div class="debug-section">
        <h3>1. 测试股票搜索API</h3>
        <input type="text" id="search-input" placeholder="输入股票名称或代码" value="苹果">
        <button onclick="testSearchStocks()">搜索股票</button>
        <div id="search-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. 测试股票预测API</h3>
        <input type="text" id="symbol-input" placeholder="股票代码" value="AAPL">
        <select id="market-select">
            <option value="us_stocks">美股</option>
            <option value="hk_stocks">港股</option>
            <option value="cn_stocks">A股</option>
            <option value="crypto">加密货币</option>
        </select>
        <button onclick="testPredictStock()">预测股票</button>
        <div id="predict-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. 测试市场信息API</h3>
        <button onclick="testMarketInfo()">获取市场信息</button>
        <div id="market-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. 调试日志</h3>
        <div id="debug-log" class="result" style="height: 200px; overflow-y: auto;"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        // 调试日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        // 测试股票搜索
        async function testSearchStocks() {
            const query = document.getElementById('search-input').value;
            const resultDiv = document.getElementById('search-result');
            
            log(`🔍 开始搜索股票: ${query}`);
            
            try {
                const response = await fetch('/api/search-stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ 搜索成功，找到 ${data.count} 个结果`);
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>搜索结果 (${data.count} 个):</h4>
                        ${data.results.map(stock => `
                            <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                                <strong>${stock.symbol}</strong> - ${stock.cn_name} (${stock.en_name})
                                <br><small>市场: ${stock.market} | 匹配类型: ${stock.match_type}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    log(`❌ 搜索失败: ${data.error}`, 'error');
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `搜索失败: ${data.error}`;
                }
            } catch (error) {
                log(`❌ 搜索请求异常: ${error.message}`, 'error');
                resultDiv.className = 'result error';
                resultDiv.textContent = `请求异常: ${error.message}`;
            }
        }
        
        // 测试股票预测
        async function testPredictStock() {
            const symbol = document.getElementById('symbol-input').value;
            const market = document.getElementById('market-select').value;
            const resultDiv = document.getElementById('predict-result');
            
            log(`📈 开始预测股票: ${symbol} (${market})`);
            
            try {
                const response = await fetch('/api/predict-stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        market: market,
                        pred_days: 5,
                        lookback_days: 60
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ 预测成功，使用模型: ${data.model_used}`);
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>预测结果:</h4>
                        <p><strong>股票:</strong> ${data.symbol} (${data.market})</p>
                        <p><strong>当前价格:</strong> $${data.current_price}</p>
                        <p><strong>预测价格:</strong> $${data.summary.final_price}</p>
                        <p><strong>预计涨跌:</strong> ${data.summary.total_change_pct}% (${data.summary.trend})</p>
                        <p><strong>使用模型:</strong> ${data.model_used}</p>
                        <p><strong>置信度:</strong> ${data.summary.confidence}</p>
                        <h5>详细预测:</h5>
                        ${data.predictions.slice(0, 3).map(pred => `
                            <div style="margin: 2px 0;">
                                ${pred.date}: $${pred.predicted_price} (${pred.change_pct > 0 ? '+' : ''}${pred.change_pct}%)
                            </div>
                        `).join('')}
                    `;
                } else {
                    log(`❌ 预测失败: ${data.error}`, 'error');
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `预测失败: ${data.error}`;
                }
            } catch (error) {
                log(`❌ 预测请求异常: ${error.message}`, 'error');
                resultDiv.className = 'result error';
                resultDiv.textContent = `请求异常: ${error.message}`;
            }
        }
        
        // 测试市场信息
        async function testMarketInfo() {
            const resultDiv = document.getElementById('market-result');
            
            log('🌐 获取市场信息');
            
            try {
                const response = await fetch('/api/stock-markets');
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ 市场信息获取成功`);
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>支持的市场:</h4>
                        <p><strong>预测器可用:</strong> ${data.predictor_available ? '是' : '否'}</p>
                        ${Object.entries(data.markets).map(([key, market]) => `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 3px;">
                                <strong>${market.name}</strong> (${key})
                                <br>${market.description}
                                <br><small>示例: ${market.examples.join(', ')}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    log(`❌ 市场信息获取失败: ${data.error}`, 'error');
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `获取失败: ${data.error}`;
                }
            } catch (error) {
                log(`❌ 市场信息请求异常: ${error.message}`, 'error');
                resultDiv.className = 'result error';
                resultDiv.textContent = `请求异常: ${error.message}`;
            }
        }
        
        // 页面加载时的初始化
        window.onload = function() {
            log('🚀 调试页面已加载');
            log('💡 请先测试各个API功能，然后查看主页面是否正常工作');
        };
    </script>
</body>
</html>